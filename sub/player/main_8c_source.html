<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>AiCPlayer: src/main.c Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />



</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">AiCPlayer
   
   </div>
   <div id="projectbrief">Interface of aic vm - for rendering aspect, sensors, video records</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Quick&#160;intro</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">src/main.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="main_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;SDL2/SDL.h&gt;</span>           <span class="comment">// for SDL_Init, SDL_INIT_VIDEO, SDL_Quit</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;SDL2/SDL_error.h&gt;</span>     <span class="comment">// for SDL_GetError</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &lt;SDL2/SDL_events.h&gt;</span>    <span class="comment">// for SDL_Event, SDL_UserEvent, SDL_MouseMo..</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &lt;SDL2/SDL_keyboard.h&gt;</span>  <span class="comment">// for SDL_Keysym</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &lt;SDL2/SDL_mouse.h&gt;</span>     <span class="comment">// for SDL_GetMouseState, SDL_BUTTON_LEFT</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &lt;SDL2/SDL_render.h&gt;</span>    <span class="comment">// for SDL_CreateRenderer, SDL_RenderClear</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;SDL2/SDL_surface.h&gt;</span>   <span class="comment">// for SDL_CreateRGBSurface, SDL_FreeSurface</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &lt;SDL2/SDL_syswm.h&gt;</span>     <span class="comment">// for SDL_SysWMinfo, SDL_GetWindowWMInfo</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &lt;SDL2/SDL_version.h&gt;</span>   <span class="comment">// for SDL_VERSION</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &lt;SDL2/SDL_video.h&gt;</span>     <span class="comment">// for SDL_Window, SDL_SetWindowSize, SDL_WI..</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &lt;X11/Xlib.h&gt;</span>           <span class="comment">// for XInitThreads, XOpenDisplay, Display</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &lt;pthread.h&gt;</span>            <span class="comment">// for pthread_t</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &lt;signal.h&gt;</span>             <span class="comment">// for signal, SIGPIPE, SIGSEGV, SIG_IGN</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &lt;stdint.h&gt;</span>             <span class="comment">// for int32_t</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &lt;stdio.h&gt;</span>              <span class="comment">// for NULL, snprintf</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>             <span class="comment">// for atexit, exit, free, malloc</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &lt;string.h&gt;</span>             <span class="comment">// for strncmp</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &lt;unistd.h&gt;</span>             <span class="comment">// for close</span>
<a name="l00057"></a>00057 
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="buffer__sizes_8h.html" title="Define common buffer sizes.">buffer_sizes.h</a>&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="config__env_8h.html" title="Utilities to get config values from the environment.">config_env.h</a>&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="dump__trace_8h.html" title="Define dump_trace()">dump_trace.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="grabber_8h.html" title="grabber records videos or snapshots from ampq messages">grabber.h</a>&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="host__gl_8h.html" title="OpenGL proxy management.">host_gl.h</a>&quot;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;<a class="code" href="logger_8h.html" title="Logging macros.">logger.h</a>&quot;</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include &quot;<a class="code" href="render__api_8h.html" title="Header for functions defined in the AOSP opengl libs.">render_api.h</a>&quot;</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include &quot;<a class="code" href="sdl__events_8h.html" title="Produce virtual input events from SDL events.">sdl_events.h</a>&quot;</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include &quot;<a class="code" href="sensors_8h.html" title="Defines ports and structures for sensor threads.">sensors.h</a>&quot;</span>
<a name="l00067"></a>00067 <span class="preprocessor">#include &quot;<a class="code" href="socket_8h.html" title="Define socket utilities to simplify networking.">socket.h</a>&quot;</span>
<a name="l00068"></a>00068 
<a name="l00069"></a><a class="code" href="main_8c.html#a7ce0df38eb467e59f209470c8f5ac4e6">00069</a> <span class="preprocessor">#define LOG_TAG &quot;main&quot;</span>
<a name="l00070"></a>00070 <span class="preprocessor"></span>
<a name="l00071"></a><a class="code" href="main_8c.html#a17676ea61e4ed741007f55af61f54be5">00071</a> <span class="preprocessor">#define USER_EVENT_ROTATION 1</span>
<a name="l00072"></a>00072 <span class="preprocessor"></span>
<a name="l00073"></a><a class="code" href="main_8c.html#aa8d7cc77567beff0a1e499d54807255d">00073</a> <span class="preprocessor">#define USER_EVENT_NEWCLIENT 2</span>
<a name="l00074"></a>00074 <span class="preprocessor"></span>
<a name="l00076"></a><a class="code" href="main_8c.html#a20bbd303d613b11460252e119077a1ac">00076</a> <span class="preprocessor">#define INPUT_PORT 22469</span>
<a name="l00077"></a>00077 <span class="preprocessor"></span>
<a name="l00078"></a>00078 <span class="keyword">static</span> SDL_Surface* s_window_surface = NULL;
<a name="l00079"></a>00079 <span class="keyword">static</span> SDL_Window* s_window = NULL;
<a name="l00080"></a>00080 <span class="keyword">static</span> <span class="keywordtype">char</span>* s_vmip = NULL;
<a name="l00081"></a>00081 <span class="keyword">static</span> <span class="keywordtype">int</span> input_in_progress = 0;
<a name="l00082"></a>00082 
<a name="l00087"></a><a class="code" href="sdl__events_8c.html#a2d8e0f99a0335c685d9f3b12e8212811">00087</a> <span class="keywordtype">int</span> <a class="code" href="grabber_8c.html#a2d8e0f99a0335c685d9f3b12e8212811" title="Global variable for the window height.">g_height</a>;
<a name="l00088"></a>00088 
<a name="l00093"></a><a class="code" href="sdl__events_8c.html#a20cb2690069b1ba7821a2098b4b8590d">00093</a> <span class="keywordtype">int</span> <a class="code" href="grabber_8c.html#a20cb2690069b1ba7821a2098b4b8590d" title="Global variable for the window width.">g_width</a>;
<a name="l00094"></a>00094 
<a name="l00100"></a><a class="code" href="sdl__events_8c.html#a9ffc1311d2ed455ea05e12f89c0e8084">00100</a> <span class="keywordtype">float</span> <a class="code" href="main_8c.html#a9ffc1311d2ed455ea05e12f89c0e8084">g_rotation</a> = 0.0;
<a name="l00101"></a>00101 
<a name="l00103"></a><a class="code" href="main_8c.html#a73b874a26cb7b8b0eaeb40b79dd928a5">00103</a> <span class="keywordtype">void</span>* <a class="code" href="grabber_8c.html#a28161d5722722adbb104dc4d7927974e" title="Global variable for the X window id.">g_window_id</a> = NULL;
<a name="l00104"></a>00104 
<a name="l00106"></a>00106 <span class="keyword">static</span> SDL_Window* open_window(<span class="keywordtype">int</span> width, <span class="keywordtype">int</span> height)
<a name="l00107"></a>00107 {
<a name="l00108"></a>00108     <span class="keywordtype">char</span> title[<a class="code" href="buffer__sizes_8h.html#a6821bafc3c88dfb2e433a095df9940c6" title="Small, fixed-size buffers.">BUF_SIZE</a>];
<a name="l00109"></a>00109     SDL_Window* window;
<a name="l00110"></a>00110     SDL_Renderer* renderer;
<a name="l00111"></a>00111 
<a name="l00112"></a>00112     <span class="keywordflow">if</span> (SDL_Init(SDL_INIT_VIDEO))
<a name="l00113"></a>00113         <a class="code" href="logger_8h.html#ae02538a80ad5fc009caec73487d11a8d" title="Log at ERROR level (makes the application abort)">LOGE</a>(<span class="stringliteral">&quot;SDL_Init failed: %s\n&quot;</span>, SDL_GetError());
<a name="l00114"></a>00114 
<a name="l00115"></a>00115     atexit(SDL_Quit);
<a name="l00116"></a>00116     snprintf(title, <span class="keyword">sizeof</span>(title), <span class="stringliteral">&quot;AiC Player (%i * %i)&quot;</span>, width, height);
<a name="l00117"></a>00117     window =
<a name="l00118"></a>00118         SDL_CreateWindow(title, 0, 0, width, height, SDL_WINDOW_OPENGL | SDL_WINDOW_ALLOW_HIGHDPI);
<a name="l00119"></a>00119     <span class="keywordflow">if</span> (!window)
<a name="l00120"></a>00120         <a class="code" href="logger_8h.html#ae02538a80ad5fc009caec73487d11a8d" title="Log at ERROR level (makes the application abort)">LOGE</a>(<span class="stringliteral">&quot;Can&#39;t create window&quot;</span>);
<a name="l00121"></a>00121 
<a name="l00122"></a>00122     <a class="code" href="grabber_8h.html#a74b78220ef8602f9341bed3375e9b20a" title="Set the static X display pointer.">grabber_set_display</a>(XOpenDisplay(NULL));
<a name="l00123"></a>00123     renderer = SDL_CreateRenderer(window, -1, SDL_RENDERER_ACCELERATED);
<a name="l00124"></a>00124 
<a name="l00125"></a>00125     <span class="keywordflow">if</span> (renderer == NULL)
<a name="l00126"></a>00126         <a class="code" href="logger_8h.html#ae02538a80ad5fc009caec73487d11a8d" title="Log at ERROR level (makes the application abort)">LOGE</a>(<span class="stringliteral">&quot;Can&#39;t create renderer&quot;</span>);
<a name="l00127"></a>00127 
<a name="l00128"></a>00128     s_window_surface = SDL_CreateRGBSurface(SDL_SWSURFACE, width, height, 32, 0, 0, 0, 0);
<a name="l00129"></a>00129     SDL_SetRenderDrawColor(renderer, 3, 169, 244, 255);
<a name="l00130"></a>00130     SDL_RenderClear(renderer);
<a name="l00131"></a>00131     SDL_RenderPresent(renderer);
<a name="l00132"></a>00132 
<a name="l00133"></a>00133     <span class="keywordflow">return</span> window;
<a name="l00134"></a>00134 }
<a name="l00135"></a>00135 
<a name="l00137"></a>00137 <span class="keyword">static</span> <span class="keywordtype">void</span>* get_window_id(SDL_Window* window)
<a name="l00138"></a>00138 {
<a name="l00139"></a>00139     SDL_SysWMinfo wminfo;
<a name="l00140"></a>00140     <span class="keywordtype">void</span>* winhandle;
<a name="l00141"></a>00141 
<a name="l00142"></a>00142     SDL_VERSION(&amp;wminfo.version);
<a name="l00143"></a>00143     SDL_GetWindowWMInfo(window, &amp;wminfo);
<a name="l00144"></a>00144     winhandle = (<span class="keywordtype">void</span>*) wminfo.info.x11.window;
<a name="l00145"></a>00145     <span class="keywordflow">return</span> winhandle;
<a name="l00146"></a>00146 }
<a name="l00147"></a>00147 
<a name="l00149"></a>00149 <span class="keyword">static</span> <span class="keywordtype">void</span> callback_rotation(<span class="keywordtype">float</span> angle)
<a name="l00150"></a>00150 {
<a name="l00151"></a>00151     <span class="keywordtype">float</span>* angle_alloc = (<span class="keywordtype">float</span>*) malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00152"></a>00152     <span class="keywordflow">if</span> (!angle_alloc)
<a name="l00153"></a>00153         <a class="code" href="logger_8h.html#ae02538a80ad5fc009caec73487d11a8d" title="Log at ERROR level (makes the application abort)">LOGE</a>(<span class="stringliteral">&quot;callback_rotation(): out of memory&quot;</span>);
<a name="l00154"></a>00154     SDL_Event rotation_event;
<a name="l00155"></a>00155     rotation_event.type = SDL_USEREVENT;
<a name="l00156"></a>00156     rotation_event.user.code = <a class="code" href="main_8c.html#a17676ea61e4ed741007f55af61f54be5">USER_EVENT_ROTATION</a>;
<a name="l00157"></a>00157     <a class="code" href="logger_8h.html#a5512e59d578a380a441a70256af997d0" title="Log at INFO level.">LOGI</a>(<span class="stringliteral">&quot;Rotation callback from the VM: %f &quot;</span>, angle);
<a name="l00158"></a>00158     *angle_alloc = angle;
<a name="l00159"></a>00159     rotation_event.user.data2 = angle_alloc;
<a name="l00160"></a>00160     SDL_PushEvent(&amp;rotation_event);
<a name="l00161"></a>00161 }
<a name="l00162"></a>00162 
<a name="l00164"></a>00164 <span class="keyword">static</span> <span class="keywordtype">void</span> recreate_subwindow(<span class="keywordtype">int</span> width, <span class="keywordtype">int</span> height, <span class="keywordtype">float</span> rotation)
<a name="l00165"></a>00165 {
<a name="l00166"></a>00166     <a class="code" href="render__api_8h.html#a3caca688297dc497d41afceca14a4178">setOpenGLDisplayRotation</a>(rotation);
<a name="l00167"></a>00167     <a class="code" href="render__api_8h.html#ab820e904a80e765787d7495373afc575">destroyOpenGLSubwindow</a>();
<a name="l00168"></a>00168     SDL_FreeSurface(s_window_surface);
<a name="l00169"></a>00169     s_window_surface = SDL_CreateRGBSurface(SDL_SWSURFACE, width, height, 32, 0, 0, 0, 0);
<a name="l00170"></a>00170     <span class="keywordflow">if</span> (!s_window_surface)
<a name="l00171"></a>00171         <a class="code" href="logger_8h.html#ae02538a80ad5fc009caec73487d11a8d" title="Log at ERROR level (makes the application abort)">LOGE</a>(<span class="stringliteral">&quot;Unable to recreate Window surface&quot;</span>);
<a name="l00172"></a>00172 
<a name="l00173"></a>00173     <a class="code" href="grabber_8c.html#a28161d5722722adbb104dc4d7927974e" title="Global variable for the X window id.">g_window_id</a> = get_window_id(s_window);
<a name="l00174"></a>00174     <a class="code" href="render__api_8h.html#a68714790601e21a0462f6fc18d38c952">createOpenGLSubwindow</a>(<a class="code" href="grabber_8c.html#a28161d5722722adbb104dc4d7927974e" title="Global variable for the X window id.">g_window_id</a>, 0, 0, width, height, rotation);
<a name="l00175"></a>00175     SDL_SetWindowSize(s_window, width, height);
<a name="l00176"></a>00176 }
<a name="l00177"></a>00177 
<a name="l00179"></a>00179 <span class="keyword">static</span> <span class="keywordtype">void</span> do_rotation(<span class="keywordtype">float</span> rotation)
<a name="l00180"></a>00180 {
<a name="l00181"></a>00181     <a class="code" href="logger_8h.html#a5512e59d578a380a441a70256af997d0" title="Log at INFO level.">LOGI</a>(<span class="stringliteral">&quot;Rotating the screen to: %f°&quot;</span>, rotation);
<a name="l00182"></a>00182     <span class="keywordflow">switch</span> ((<span class="keywordtype">int</span>) rotation)
<a name="l00183"></a>00183     {
<a name="l00184"></a>00184     <span class="keywordflow">case</span> 0:
<a name="l00185"></a>00185     <span class="keywordflow">case</span> 180:
<a name="l00186"></a>00186         recreate_subwindow(<a class="code" href="grabber_8c.html#a20cb2690069b1ba7821a2098b4b8590d" title="Global variable for the window width.">g_width</a>, <a class="code" href="grabber_8c.html#a2d8e0f99a0335c685d9f3b12e8212811" title="Global variable for the window height.">g_height</a>, rotation);
<a name="l00187"></a>00187         <span class="keywordflow">break</span>;
<a name="l00188"></a>00188     <span class="keywordflow">case</span> 90:
<a name="l00189"></a>00189     <span class="keywordflow">case</span> 270:
<a name="l00190"></a>00190         recreate_subwindow(<a class="code" href="grabber_8c.html#a2d8e0f99a0335c685d9f3b12e8212811" title="Global variable for the window height.">g_height</a>, <a class="code" href="grabber_8c.html#a20cb2690069b1ba7821a2098b4b8590d" title="Global variable for the window width.">g_width</a>, rotation);
<a name="l00191"></a>00191         <span class="keywordflow">break</span>;
<a name="l00192"></a>00192     <span class="keywordflow">default</span>:
<a name="l00193"></a>00193         <a class="code" href="logger_8h.html#ae02538a80ad5fc009caec73487d11a8d" title="Log at ERROR level (makes the application abort)">LOGE</a>(<span class="stringliteral">&quot;Unknown rotation value: %f°&quot;</span>, rotation);
<a name="l00194"></a>00194         <span class="keywordflow">break</span>;
<a name="l00195"></a>00195     }
<a name="l00196"></a>00196 
<a name="l00197"></a>00197     <a class="code" href="render__api_8h.html#a96c6f283c139fea57d4d0e0df57703f6">repaintOpenGLDisplay</a>();
<a name="l00198"></a>00198     <a class="code" href="main_8c.html#a9ffc1311d2ed455ea05e12f89c0e8084">g_rotation</a> = rotation;
<a name="l00199"></a>00199 }
<a name="l00200"></a>00200 
<a name="l00201"></a>00201 <span class="keyword">static</span> <span class="keywordtype">void</span> rotation_received(<span class="keywordtype">float</span> rotation)
<a name="l00202"></a>00202 {
<a name="l00203"></a>00203     <span class="keywordflow">if</span> (rotation == 0.0 || rotation == 90.0 || rotation == 180.0 || rotation == 270.0)
<a name="l00204"></a>00204         do_rotation(rotation);
<a name="l00205"></a>00205     <span class="keywordflow">else</span>
<a name="l00206"></a>00206         <a class="code" href="logger_8h.html#a07f1b0d507acedeb7550353eba4f6e66" title="Log at WARNING level.">LOGW</a>(<span class="stringliteral">&quot;Unexpected rotation value: %f°&quot;</span>, rotation);
<a name="l00207"></a>00207 }
<a name="l00208"></a>00208 
<a name="l00210"></a>00210 <span class="keyword">static</span> <span class="keywordtype">void</span>* connect_input(<span class="keywordtype">void</span>* arg)
<a name="l00211"></a>00211 {
<a name="l00212"></a>00212     (void) arg;
<a name="l00213"></a>00213     input_in_progress = 1;
<a name="l00214"></a>00214 
<a name="l00215"></a>00215     <a class="code" href="socket_8h.html#a30353f381f5fccbb956eea1f3a110b6c" title="Alias to differenciate between regular ints and socket fds.">socket_t</a>* input_socket = (<a class="code" href="socket_8h.html#a30353f381f5fccbb956eea1f3a110b6c" title="Alias to differenciate between regular ints and socket fds.">socket_t</a>*) malloc(<span class="keyword">sizeof</span>(<a class="code" href="socket_8h.html#a30353f381f5fccbb956eea1f3a110b6c" title="Alias to differenciate between regular ints and socket fds.">socket_t</a>));
<a name="l00216"></a>00216     <span class="keywordflow">if</span> (!input_socket)
<a name="l00217"></a>00217         <a class="code" href="logger_8h.html#ae02538a80ad5fc009caec73487d11a8d" title="Log at ERROR level (makes the application abort)">LOGE</a>(<span class="stringliteral">&quot;connect_input thread: out of memory&quot;</span>);
<a name="l00218"></a>00218     <span class="keywordflow">do</span>
<a name="l00219"></a>00219     {
<a name="l00220"></a>00220         *input_socket = <a class="code" href="socket_8h.html#a548f0ed12e49a65bf1a6b62c0d30ccab" title="Connect to a host:port couple.">open_socket</a>(s_vmip, <a class="code" href="main_8c.html#a20bbd303d613b11460252e119077a1ac">INPUT_PORT</a>);
<a name="l00221"></a>00221         <span class="keywordflow">if</span> (*input_socket == <a class="code" href="socket_8h.html#a633b0396ff93d336a088412a190a5072" title="Alias for the recv() return value in case of error.">SOCKET_ERROR</a>)
<a name="l00222"></a>00222         {
<a name="l00223"></a>00223             <a class="code" href="logger_8h.html#a07f1b0d507acedeb7550353eba4f6e66" title="Log at WARNING level.">LOGW</a>(<span class="stringliteral">&quot;Could not connect to input daemon (:%d): %s&quot;</span>, <a class="code" href="main_8c.html#a20bbd303d613b11460252e119077a1ac">INPUT_PORT</a>, strerror(errno));
<a name="l00224"></a>00224             <a class="code" href="test_validate_n_f_c___r_e_a_d_m_e_8md.html#a64ec70591e393276b5f75643496fcc97">sleep</a>(1);
<a name="l00225"></a>00225         }
<a name="l00226"></a>00226     } <span class="keywordflow">while</span> (*input_socket == <a class="code" href="socket_8h.html#a633b0396ff93d336a088412a190a5072" title="Alias for the recv() return value in case of error.">SOCKET_ERROR</a>);
<a name="l00227"></a>00227     <a class="code" href="logger_8h.html#a5512e59d578a380a441a70256af997d0" title="Log at INFO level.">LOGI</a>(<span class="stringliteral">&quot;input client connected with socket %d&quot;</span>, *input_socket);
<a name="l00228"></a>00228 
<a name="l00229"></a>00229     SDL_Event conn_event;
<a name="l00230"></a>00230     conn_event.type = SDL_USEREVENT;
<a name="l00231"></a>00231     conn_event.user.code = <a class="code" href="main_8c.html#aa8d7cc77567beff0a1e499d54807255d">USER_EVENT_NEWCLIENT</a>;
<a name="l00232"></a>00232     conn_event.user.data1 = input_socket;
<a name="l00233"></a>00233     SDL_PushEvent(&amp;conn_event);
<a name="l00234"></a>00234     input_in_progress = 0;
<a name="l00235"></a>00235 
<a name="l00236"></a>00236     <span class="keywordflow">return</span> 0;
<a name="l00237"></a>00237 }
<a name="l00238"></a>00238 
<a name="l00240"></a>00240 <span class="keyword">static</span> <span class="keywordtype">void</span> main_loop(<span class="keywordtype">int</span> width, <span class="keywordtype">int</span> height)
<a name="l00241"></a>00241 {
<a name="l00242"></a>00242     SDL_Event event;
<a name="l00243"></a>00243     <a class="code" href="socket_8h.html#a30353f381f5fccbb956eea1f3a110b6c" title="Alias to differenciate between regular ints and socket fds.">socket_t</a> input_socket = 0;
<a name="l00244"></a>00244     pthread_t input_thread;
<a name="l00245"></a>00245 
<a name="l00246"></a>00246 reconnect:
<a name="l00247"></a>00247     <span class="keywordflow">if</span> (input_socket &gt; 0)
<a name="l00248"></a>00248     {
<a name="l00249"></a>00249         close(input_socket);
<a name="l00250"></a>00250         input_socket = 0;
<a name="l00251"></a>00251         <span class="keywordflow">if</span> (!input_in_progress)
<a name="l00252"></a>00252         {
<a name="l00253"></a>00253             <span class="keywordflow">if</span> (pthread_create(&amp;input_thread, NULL, connect_input, NULL) != 0)
<a name="l00254"></a>00254                 <a class="code" href="logger_8h.html#ae02538a80ad5fc009caec73487d11a8d" title="Log at ERROR level (makes the application abort)">LOGE</a>(<span class="stringliteral">&quot;Unable to start input thread, exiting...&quot;</span>);
<a name="l00255"></a>00255         }
<a name="l00256"></a>00256     }
<a name="l00257"></a>00257 
<a name="l00258"></a>00258     <span class="keywordflow">while</span> (SDL_WaitEvent(&amp;event))
<a name="l00259"></a>00259     {
<a name="l00260"></a>00260         <span class="keywordflow">switch</span> (event.type)
<a name="l00261"></a>00261         {
<a name="l00262"></a>00262         <span class="keywordflow">case</span> SDL_USEREVENT:
<a name="l00263"></a>00263             <span class="keywordflow">switch</span> (event.user.code)
<a name="l00264"></a>00264             {
<a name="l00265"></a>00265             <span class="keywordflow">case</span> <a class="code" href="main_8c.html#a17676ea61e4ed741007f55af61f54be5">USER_EVENT_ROTATION</a>:
<a name="l00266"></a>00266                 rotation_received(*(<span class="keywordtype">float</span>*) event.user.data2);
<a name="l00267"></a>00267                 free(event.user.data2);
<a name="l00268"></a>00268                 <span class="keywordflow">break</span>;
<a name="l00269"></a>00269             <span class="keywordflow">case</span> <a class="code" href="main_8c.html#aa8d7cc77567beff0a1e499d54807255d">USER_EVENT_NEWCLIENT</a>:
<a name="l00270"></a>00270                 <span class="keywordflow">if</span> (input_socket)
<a name="l00271"></a>00271                     close(input_socket);
<a name="l00272"></a>00272                 <span class="keywordtype">char</span> buffer[<a class="code" href="buffer__sizes_8h.html#a6821bafc3c88dfb2e433a095df9940c6" title="Small, fixed-size buffers.">BUF_SIZE</a>];
<a name="l00273"></a>00273                 input_socket = *(<a class="code" href="socket_8h.html#a30353f381f5fccbb956eea1f3a110b6c" title="Alias to differenciate between regular ints and socket fds.">socket_t</a>*) event.user.data1;
<a name="l00274"></a>00274                 free(event.user.data1);
<a name="l00275"></a>00275                 <a class="code" href="logger_8h.html#a5512e59d578a380a441a70256af997d0" title="Log at INFO level.">LOGI</a>(<span class="stringliteral">&quot;Got new uinput client, socket=%d&quot;</span>, input_socket);
<a name="l00276"></a>00276                 snprintf(buffer, <a class="code" href="buffer__sizes_8h.html#a6821bafc3c88dfb2e433a095df9940c6" title="Small, fixed-size buffers.">BUF_SIZE</a>, <span class="stringliteral">&quot;CONFIG:%d:%d\n&quot;</span>, width, height);
<a name="l00277"></a>00277                 send(input_socket, buffer, strlen(buffer), 0);
<a name="l00278"></a>00278                 <span class="keywordflow">break</span>;
<a name="l00279"></a>00279             }
<a name="l00280"></a>00280             <span class="keywordflow">break</span>;
<a name="l00281"></a>00281         <span class="keywordflow">case</span> SDL_MOUSEMOTION:
<a name="l00282"></a>00282             <span class="keywordflow">if</span> (<a class="code" href="sdl__events_8h.html#acd60f7c3920fb89b2868a3a0276866e3" title="Produce a mouse motion event to the virtual input.">sdl_mouse_motion</a>(&amp;event, input_socket) == <a class="code" href="socket_8h.html#a633b0396ff93d336a088412a190a5072" title="Alias for the recv() return value in case of error.">SOCKET_ERROR</a>)
<a name="l00283"></a>00283                 <span class="keywordflow">goto</span> reconnect;
<a name="l00284"></a>00284             <span class="keywordflow">break</span>;
<a name="l00285"></a>00285         <span class="keywordflow">case</span> SDL_MOUSEBUTTONDOWN:
<a name="l00286"></a>00286         <span class="keywordflow">case</span> SDL_MOUSEBUTTONUP:
<a name="l00287"></a>00287             <span class="keywordflow">if</span> (<a class="code" href="sdl__events_8h.html#a8bdf8a23aa4e8a98c260730dab76b191" title="Produce a mouse click event to the virtual input.">sdl_mouse_button</a>(&amp;event, input_socket) == <a class="code" href="socket_8h.html#a633b0396ff93d336a088412a190a5072" title="Alias for the recv() return value in case of error.">SOCKET_ERROR</a>)
<a name="l00288"></a>00288                 <span class="keywordflow">goto</span> reconnect;
<a name="l00289"></a>00289             <span class="keywordflow">break</span>;
<a name="l00290"></a>00290         <span class="keywordflow">case</span> SDL_MOUSEWHEEL:
<a name="l00291"></a>00291             <span class="keywordflow">if</span> (<a class="code" href="sdl__events_8h.html#a57130f745e486ff002b6d0b09f6ff8d9" title="Produce a mouse wheel event to the virtual input.">sdl_mouse_wheel</a>(&amp;event, input_socket) == <a class="code" href="socket_8h.html#a633b0396ff93d336a088412a190a5072" title="Alias for the recv() return value in case of error.">SOCKET_ERROR</a>)
<a name="l00292"></a>00292                 <span class="keywordflow">goto</span> reconnect;
<a name="l00293"></a>00293             <span class="keywordflow">break</span>;
<a name="l00294"></a>00294         <span class="keywordflow">case</span> SDL_KEYDOWN:
<a name="l00295"></a>00295         <span class="keywordflow">case</span> SDL_KEYUP:
<a name="l00296"></a>00296             <span class="keywordflow">if</span> (<a class="code" href="sdl__events_8h.html#addfa3b2d26af3642ad3bd8c4418a43e3" title="Produce a key press/release event to the virtual input.">sdl_key</a>(&amp;event, input_socket) == <a class="code" href="socket_8h.html#a633b0396ff93d336a088412a190a5072" title="Alias for the recv() return value in case of error.">SOCKET_ERROR</a>)
<a name="l00297"></a>00297                 <span class="keywordflow">goto</span> reconnect;
<a name="l00298"></a>00298             <span class="keywordflow">break</span>;
<a name="l00299"></a>00299         <span class="keywordflow">case</span> SDL_QUIT:
<a name="l00300"></a>00300             exit(0);
<a name="l00301"></a>00301             <span class="keywordflow">break</span>;
<a name="l00302"></a>00302         }
<a name="l00303"></a>00303     }
<a name="l00304"></a>00304 }
<a name="l00305"></a>00305 
<a name="l00306"></a><a class="code" href="main_8c.html#ae66f6b31b5ad750f1fe042a706a4e3d4">00306</a> <span class="keywordtype">int</span> <a class="code" href="main_8c.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>()
<a name="l00307"></a>00307 {
<a name="l00308"></a>00308     <a class="code" href="logger_8h.html#ab3d0e9567cfad5d6f83abc585beb520d">init_logger</a>();
<a name="l00309"></a>00309 
<a name="l00310"></a>00310     <span class="comment">// env parameters</span>
<a name="l00311"></a>00311     <span class="keywordtype">char</span>* amqp_host;
<a name="l00312"></a>00312     <span class="keywordtype">char</span>* path_results;
<a name="l00313"></a>00313     <span class="keywordtype">char</span>* vm_id;
<a name="l00314"></a>00314     <span class="keywordtype">int</span> dpi;
<a name="l00315"></a>00315     <span class="keywordtype">int</span> enable_record;
<a name="l00316"></a>00316     <span class="keywordtype">int</span> height;
<a name="l00317"></a>00317     <span class="keywordtype">int</span> width;
<a name="l00318"></a>00318 
<a name="l00319"></a>00319     <span class="keyword">static</span> <span class="keywordtype">char</span> port_gl[] = <span class="stringliteral">&quot;22468&quot;</span>;
<a name="l00320"></a>00320 
<a name="l00321"></a>00321     pthread_t gl_thread;
<a name="l00322"></a>00322     pthread_t input_thread;
<a name="l00323"></a>00323     pthread_t amqp_grabber_thread;
<a name="l00324"></a>00324     pthread_t socket_grabber_thread;
<a name="l00325"></a>00325 
<a name="l00326"></a>00326     av_register_all();
<a name="l00327"></a>00327 
<a name="l00328"></a>00328     <span class="comment">// print stack trace upon segmentation fault</span>
<a name="l00329"></a>00329 
<a name="l00330"></a>00330     signal(SIGSEGV, <a class="code" href="dump__trace_8h.html#a1dbeb43c562db25d4cabbc112fc8f409" title="Dump a backtrace if there is a segfault.">dump_trace</a>);
<a name="l00331"></a>00331     signal(SIGPIPE, SIG_IGN);
<a name="l00332"></a>00332 
<a name="l00333"></a>00333     <span class="comment">// All config values are mandatory, no defaults.</span>
<a name="l00334"></a>00334 
<a name="l00335"></a>00335     amqp_host = <a class="code" href="config__env_8h.html#a7a3442c830784b7d0aea5290269232ad" title="Get the value of a config variable from the env.">configvar_string</a>(<span class="stringliteral">&quot;AIC_PLAYER_AMQP_HOST&quot;</span>);
<a name="l00336"></a>00336     vm_id = <a class="code" href="config__env_8h.html#a7a3442c830784b7d0aea5290269232ad" title="Get the value of a config variable from the env.">configvar_string</a>(<span class="stringliteral">&quot;AIC_PLAYER_VM_ID&quot;</span>);
<a name="l00337"></a>00337     s_vmip = <a class="code" href="config__env_8h.html#a7a3442c830784b7d0aea5290269232ad" title="Get the value of a config variable from the env.">configvar_string</a>(<span class="stringliteral">&quot;AIC_PLAYER_VM_HOST&quot;</span>);
<a name="l00338"></a>00338     width = <a class="code" href="config__env_8h.html#a69c8b3fe2efa7bf253919822e0955b13" title="Get the value of a integer config variable from the env.">configvar_int</a>(<span class="stringliteral">&quot;AIC_PLAYER_WIDTH&quot;</span>);
<a name="l00339"></a>00339     height = <a class="code" href="config__env_8h.html#a69c8b3fe2efa7bf253919822e0955b13" title="Get the value of a integer config variable from the env.">configvar_int</a>(<span class="stringliteral">&quot;AIC_PLAYER_HEIGHT&quot;</span>);
<a name="l00340"></a>00340     enable_record = <a class="code" href="config__env_8h.html#a64a6493a7d79d58276bbd3e7a0041083" title="Get the value of a boolean config variable from the env.">configvar_bool</a>(<span class="stringliteral">&quot;AIC_PLAYER_ENABLE_RECORD&quot;</span>);
<a name="l00341"></a>00341     path_results = <a class="code" href="config__env_8h.html#a7a3442c830784b7d0aea5290269232ad" title="Get the value of a config variable from the env.">configvar_string</a>(<span class="stringliteral">&quot;AIC_PLAYER_PATH_RECORD&quot;</span>);
<a name="l00342"></a>00342     dpi = <a class="code" href="config__env_8h.html#a69c8b3fe2efa7bf253919822e0955b13" title="Get the value of a integer config variable from the env.">configvar_int</a>(<span class="stringliteral">&quot;AIC_PLAYER_DPI&quot;</span>);
<a name="l00343"></a>00343     <a class="code" href="grabber_8c.html#a20cb2690069b1ba7821a2098b4b8590d" title="Global variable for the window width.">g_width</a> = width;
<a name="l00344"></a>00344     <a class="code" href="grabber_8c.html#a2d8e0f99a0335c685d9f3b12e8212811" title="Global variable for the window height.">g_height</a> = height;
<a name="l00345"></a>00345 
<a name="l00346"></a>00346     <a class="code" href="grabber_8h.html#aedfbbbd02a0acd665e2d4acb36ff73b1" title="Set the static path to the screenshots/movies dir.">grabber_set_path_results</a>(path_results);
<a name="l00347"></a>00347 
<a name="l00348"></a>00348     XInitThreads();
<a name="l00349"></a>00349 
<a name="l00350"></a>00350     <a class="code" href="logger_8h.html#a5512e59d578a380a441a70256af997d0" title="Log at INFO level.">LOGI</a>(<span class="stringliteral">&quot;Creating window surface: %dx%d&quot;</span>, width, height);
<a name="l00351"></a>00351     s_window = open_window(width, height);
<a name="l00352"></a>00352     <a class="code" href="grabber_8c.html#a28161d5722722adbb104dc4d7927974e" title="Global variable for the X window id.">g_window_id</a> = get_window_id(s_window);
<a name="l00353"></a>00353 
<a name="l00354"></a>00354     <span class="keywordflow">if</span> (!<a class="code" href="render__api_8h.html#ab817145310afe4cfc3502a5823c97aeb">initLibrary</a>())
<a name="l00355"></a>00355         <a class="code" href="logger_8h.html#ae02538a80ad5fc009caec73487d11a8d" title="Log at ERROR level (makes the application abort)">LOGE</a>(<span class="stringliteral">&quot;Unable to initialize Library&quot;</span>);
<a name="l00356"></a>00356 
<a name="l00357"></a>00357     <span class="keywordflow">if</span> (!<a class="code" href="render__api_8h.html#a0a8064c551728bb88523a7bfc10472ce">setStreamMode</a>(<a class="code" href="render__api_8h.html#a66cfd9112c3c9ec3217dc3dfe34c0f83">STREAM_MODE_TCP</a>))
<a name="l00358"></a>00358         <a class="code" href="logger_8h.html#ae02538a80ad5fc009caec73487d11a8d" title="Log at ERROR level (makes the application abort)">LOGE</a>(<span class="stringliteral">&quot;invalid stream mode for setStreamMode()&quot;</span>);
<a name="l00359"></a>00359 
<a name="l00360"></a>00360     <span class="keywordflow">if</span> (!<a class="code" href="render__api_8h.html#a051b34bb0e79229a04c1270a5ae8de33">initOpenGLRenderer</a>(width, height, port_gl, 6))
<a name="l00361"></a>00361         <a class="code" href="logger_8h.html#ae02538a80ad5fc009caec73487d11a8d" title="Log at ERROR level (makes the application abort)">LOGE</a>(<span class="stringliteral">&quot;initOpenGLRenderer failed&quot;</span>);
<a name="l00362"></a>00362 
<a name="l00363"></a>00363     <span class="keywordflow">if</span> (pthread_create(&amp;gl_thread, NULL, (<span class="keywordtype">void</span>*) &amp;<a class="code" href="host__gl_8h.html#a996ddc93a44b79d5170cbb809ad75703" title="Manage the remote OpenGL to the VM.">manage_socket_gl</a>, s_vmip))
<a name="l00364"></a>00364         <a class="code" href="logger_8h.html#ae02538a80ad5fc009caec73487d11a8d" title="Log at ERROR level (makes the application abort)">LOGE</a>(<span class="stringliteral">&quot;Error creating thread&quot;</span>);
<a name="l00365"></a>00365 
<a name="l00366"></a>00366     <span class="keywordflow">if</span> (!<a class="code" href="render__api_8h.html#a68714790601e21a0462f6fc18d38c952">createOpenGLSubwindow</a>(<a class="code" href="grabber_8c.html#a28161d5722722adbb104dc4d7927974e" title="Global variable for the X window id.">g_window_id</a>, 0, 0, width, height, 0))
<a name="l00367"></a>00367         <a class="code" href="logger_8h.html#ae02538a80ad5fc009caec73487d11a8d" title="Log at ERROR level (makes the application abort)">LOGE</a>(<span class="stringliteral">&quot;Unable to setup SubWindow&quot;</span>);
<a name="l00368"></a>00368 
<a name="l00369"></a>00369     <a class="code" href="render__api_8h.html#a7963cb6edbe8f673efceb71159eff7fb">AiC_CallbackRotation</a>(callback_rotation);
<a name="l00370"></a>00370     <a class="code" href="render__api_8h.html#ac750289cb029558e2d02d0cfd2acc7f9">AiC_setDPI</a>(dpi);
<a name="l00371"></a>00371 
<a name="l00372"></a>00372     <a class="code" href="structs__sensor__params.html" title="Parameter for sensor threads.">sensor_params</a> param_listener;
<a name="l00373"></a>00373     <span class="keywordflow">if</span> (enable_record)
<a name="l00374"></a>00374     {
<a name="l00375"></a>00375         <span class="keywordtype">char</span> sensor_name[] = <span class="stringliteral">&quot;recording&quot;</span>;
<a name="l00376"></a>00376 
<a name="l00377"></a>00377         <span class="keyword">const</span> int32_t str_length = <a class="code" href="buffer__sizes_8h.html#a6821bafc3c88dfb2e433a095df9940c6" title="Small, fixed-size buffers.">BUF_SIZE</a>;
<a name="l00378"></a>00378         g_strlcpy(param_listener.<a class="code" href="structs__sensor__params.html#a85d9f961befcea64b5adc28704bf3b79" title="Sensor name.">sensor</a>, sensor_name, str_length);
<a name="l00379"></a>00379         param_listener.<a class="code" href="structs__sensor__params.html#a1df864aa23b6c63ecc0d948ec89e07b1" title="VM IP.">gvmip</a> = s_vmip;
<a name="l00380"></a>00380         g_strlcpy(param_listener.<a class="code" href="structs__sensor__params.html#a4e520e111c57262208811b1b77599902" title="Exchange name.">exchange</a>, sensor_name, str_length);
<a name="l00381"></a>00381 
<a name="l00382"></a>00382         snprintf(param_listener.<a class="code" href="structs__sensor__params.html#a5ef12b777d474c01c3c772b44d9f47f0" title="Queue name.">queue</a>, str_length, <span class="stringliteral">&quot;android-events.%s.%s&quot;</span>, vm_id, sensor_name);
<a name="l00383"></a>00383 
<a name="l00384"></a>00384         <span class="keywordflow">if</span> (strncmp(amqp_host, <span class="stringliteral">&quot;0&quot;</span>, 1))
<a name="l00385"></a>00385             pthread_create(&amp;amqp_grabber_thread, 0, &amp;<a class="code" href="grabber_8h.html#a59a47331bd2c7708cc7aa10a2f1f5bbc">grab_handler_amqp</a>, &amp;param_listener);
<a name="l00386"></a>00386         <span class="keywordflow">else</span>
<a name="l00387"></a>00387             <a class="code" href="logger_8h.html#a5512e59d578a380a441a70256af997d0" title="Log at INFO level.">LOGI</a>(<span class="stringliteral">&quot;Working without AMQP&quot;</span>);
<a name="l00388"></a>00388 
<a name="l00389"></a>00389         pthread_create(&amp;socket_grabber_thread, 0, &amp;<a class="code" href="grabber_8h.html#a9d9ad64cb39218bf4bd0f000fde19558" title="Start/Stop from socket connection via protobuf message.">grab_handler_sock</a>, &amp;param_listener);
<a name="l00390"></a>00390     }
<a name="l00391"></a>00391 
<a name="l00392"></a>00392     <span class="keywordflow">if</span> (pthread_create(&amp;input_thread, NULL, connect_input, NULL) != 0)
<a name="l00393"></a>00393         <a class="code" href="logger_8h.html#ae02538a80ad5fc009caec73487d11a8d" title="Log at ERROR level (makes the application abort)">LOGE</a>(<span class="stringliteral">&quot;Unable to start input thread&quot;</span>);
<a name="l00394"></a>00394 
<a name="l00395"></a>00395     main_loop(width, height);
<a name="l00396"></a>00396 
<a name="l00397"></a>00397     <span class="keywordflow">return</span> 0;
<a name="l00398"></a>00398 }
</pre></div></div><!-- contents -->


<hr class="footer"/><address class="footer"><small>
Generated on Tue Jan 24 2017 14:06:36 for AiCPlayer by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
