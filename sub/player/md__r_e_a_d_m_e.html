<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>AiCPlayer: AiCPlayer - README</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">AiCPlayer
   </div>
   <div id="projectbrief">Interface of aic vm - for rendering aspect, sensors, video records</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Quick&#160;intro</span></a></li>
      <li class="current"><a href="pages.html"><span>AiC&#160;player&#160;usage</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">AiCPlayer - README </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The AiC Player is the interface between sensors emitters and the virtual android machine. It is split into several executables:</p>
<ul>
<li>The most important one, which we can call "player", does hardware-accelerated rendering for the android UI, using the remote rendering libs (mostly vanilla) from the google emulator. Because it has access to the graphical interface, it also contains code required to record screenshots and videos from the graphical output.</li>
<li>The "player_audio" is a separate executable which connects to a custom port on the virtual machine in order to receive a raw PCM stream of the audio output of android. Its job is to copy that stream to a local ffserver instance, in order to transcode it and present it elsewhere (for example a web interface).</li>
<li>The "player_sensors"’ job is to dispatch protocol buffers containing sensor data from an AMQP queue to the different TCP ports for those sensors on the VM. Since each sensor has its dedicated AMQP queue, player_sensors does not need to filter or even read the content of the protocol buffer, only to transfer it.</li>
</ul>
<h1>Building</h1>
<hr/>
<p>TODO: Docker instructions </p>
<hr/>
<ul>
<li>Building and running only work under a moderately modern linux distribution</li>
<li>Building the whole package requires libffmpeg&gt;=2.8, pthreads, libx11, glib 2.0, libsdl2 (2.0.4), <a href="https://github.com/protobuf-c/protobuf-c">protobuf-c</a>, <a href="https://github.com/alanxz/rabbitmq-c">rabbitmq-c</a> (0.7.1)</li>
</ul>
<p>In apt terms, this gives us (as of ubuntu 16.04): </p>
<pre class="fragment">apt install \
    libav-tools \
    libavcodec-ffmpeg56 \
    libavformat-ffmpeg56 \
    libsdl2-2.0 \
    libswscale-ffmpeg3 \
    libglib2.0-0 \
    libprotobuf-c1 \
    librabbitmq4 \
    libx11-6
</pre><p>and the matching -dev packages for the headers.</p>
<ul>
<li>A C compiler, either gcc or clang are okay</li>
<li>Compile the sources:</li>
</ul>
<pre class="fragment">cmake -DBUILD_SDL=1 -DCMAKE_BUILD_TYPE=Release
make
</pre><h2>Obtaining the OpenGL rendering libs</h2>
<p>The following libs are <b>required</b> in order to get the OpenGL rendering working:</p>
<ul>
<li>lib64EGL_translator.so</li>
<li>lib64GLES_CM_translator.so</li>
<li>lib64GLES_V2_translator.so</li>
<li>lib64OpenglRender.so</li>
</ul>
<p>Because if those libs are not available, then the graphical player will not run, and android will not boot fully unless it is configured to boot without hardware acceleration.</p>
<p>To build them, you need to apply a patch to the AOSP sources in order to be able to receive rotation events, then build it using the scripts available to build the emulator (which may differ between android versions).</p>
<h1>Usage</h1>
<p>Runtime parameters are given through environment variables, which are all mandatory. Running with docker-compose is recommended (and easier) in order to have all executables running at the same time with the right parameters.</p>
<h2>Generic options</h2>
<table class="doxtable">
<tr>
<th>Option </th><th>Use  </th></tr>
<tr>
<td>AIC_PLAYER_AMQP_USERNAME </td><td>Username to access the AMQP service </td></tr>
<tr>
<td>AIC_PLAYER_AMQP_PASSWORD </td><td>Password to access the AMQP service </td></tr>
<tr>
<td>AIC_PLAYER_AMQP_HOST </td><td>Host (IP or hostname) of the AMQP server </td></tr>
<tr>
<td>AIC_PLAYER_VM_HOST </td><td>Host (IP or hostname) of the virtual machine </td></tr>
<tr>
<td>AIC_PLAYER_VM_ID </td><td>Virtual Machine ID, used to select the AMQP queue </td></tr>
</table>
<h2>Graphical player options</h2>
<table class="doxtable">
<tr>
<th>Option </th><th>Use  </th></tr>
<tr>
<td>AIC_PLAYER_DPI </td><td>Pixel density of the graphical view </td></tr>
<tr>
<td>AIC_PLAYER_WIDTH </td><td>Width of the graphical view, in pixels </td></tr>
<tr>
<td>AIC_PLAYER_HEIGHT </td><td>Height of the graphical view, in pixels </td></tr>
<tr>
<td>AIC_PLAYER_ENABLE_RECORD </td><td>Toggle recording interface (AMQP + from the VM) </td></tr>
<tr>
<td>AIC_PLAYER_PATH_RECORD </td><td>Path of the recorded files </td></tr>
</table>
<h2>Sensors player options</h2>
<table class="doxtable">
<tr>
<th>Option </th><th>Use  </th></tr>
<tr>
<td>AIC_PLAYER_ENABLE_SENSORS </td><td>Enable the misc sensors like accelerometer, thermometer, luxmeter… </td></tr>
<tr>
<td>AIC_PLAYER_ENABLE_GPS </td><td>Enable the GPS sensor </td></tr>
<tr>
<td>AIC_PLAYER_ENABLE_GSM </td><td>Enable the GSM sensor </td></tr>
<tr>
<td>AIC_PLAYER_ENABLE_BATTERY </td><td>Enable the battery sensor </td></tr>
<tr>
<td>AIC_PLAYER_ENABLE_NFC </td><td>Enable the NFC sensor </td></tr>
</table>
<p>Each option is <b>required</b> and the executables will abort if one is not found.</p>
<h2>Record files and videos locally:</h2>
<ul>
<li>Press F7 to start recording a video and F8 to stop recording it</li>
<li>Press F6 to take a snapshot</li>
</ul>
<h2>Remote commands</h2>
<p>Remote commands/sensor data are sent through AMQP queues; read the specific message documentation for more information.</p>
<table class="doxtable">
<tr>
<th>Queue name </th><th>Effect  </th></tr>
<tr>
<td>android-events.{vm_id}.battery </td><td>Forward a battery payload </td></tr>
<tr>
<td>android-events.{vm_id}.sensors </td><td>Forward a sensors payload </td></tr>
<tr>
<td>android-events.{vm_id}.gps </td><td>Forward a GPS payload </td></tr>
<tr>
<td>android-events.{vm_id}.gsm </td><td>Forward a GSM payload </td></tr>
<tr>
<td>android-events.{vm_id}.nfc </td><td>Forward a NFC payload </td></tr>
<tr>
<td>android-events.{vm_id}.recording </td><td>Toggle video recording or take a screenshot </td></tr>
</table>
<h1>Other topics</h1>
<h2>Documentation</h2>
<p>The documentation was produced using doxygen, it can be either build through the "make doc" target produced with cmake, or manually using "doxygen -g Doxyfile".</p>
<h2>Code formatting:</h2>
<p>Code is formatted with clang-format and the configuration file .clang-format is in the sdl/ directory.</p>
<h2>Static analysis with clang/scan-build:</h2>
<p>You can easily use scan-build with cmake, you only have to prefix your "cmake" and "make" invocations with scan-build, and it will automatically switch compilers and perform static analysis on the source files.</p>
<h2>Tests</h2>
<p>Building with tests requires <a href="https://github.com/google/cmockery">cmockery</a> in addition to the other dependencies.</p>
<p>Building is about the same as without testing:</p>
<pre class="fragment">cmake -DBUILD_SDL=1 -DCMAKE_BUILD_TYPE=Debug -DWITH_TEST=1
make
</pre><p>This will produce test executables in the out/ directory. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu Feb 16 2017 15:02:04 for AiCPlayer by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
