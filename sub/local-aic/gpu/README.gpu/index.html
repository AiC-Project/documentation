<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>GPU - AiC Local</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "GPU";
    var mkdocs_page_input_path = "gpu/README.gpu.md";
    var mkdocs_page_url = "/gpu/README.gpu/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js"></script>
  <script src="../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> AiC Local</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../..">AiC Local</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 current">
        <a class="current" href="./">GPU</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#using-the-gpu-for-the-rendering">Using the GPU for the rendering</a></li>
                
                    <li><a class="toctree-l4" href="#mesa">Mesa</a></li>
                
                    <li><a class="toctree-l4" href="#nvidia">Nvidia</a></li>
                
            
            </ul>
        
    </li>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">AiC Local</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
    
    <li>GPU</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="using-the-gpu-for-the-rendering">Using the GPU for the rendering</h1>
<p>The official docker images use
<a href="http://www.mesa3d.org/llvmpipe.html">mesa’s llvmpipe renderer</a> in order
to have a fully isolated OpenGL rendering process. This allows AiC to ignore
system specificities and run without issues anywhere. However, its performance
is quite limited even on powerful CPUs and it is therefore useful to use a
graphics card (even an intel integrated one) to avoid that bottleneck, which
gets worse the more AiC virtual machines you are running.</p>
<p>To use the host graphics card while still displaying content in a
containerized X server, we use <a href="http://www.virtualgl.org/">VirtualGL</a>
and the <code>vglrun</code> tool it includes.</p>
<p>To this end, the "sdl" container needs to share the X11 socket (which is
usually in <code>/tmp/.X11-unix</code>) from the host, and the linux rendering device
(see the nvidia compose file at the bottom of this page as an example).</p>
<p>The scripts also have to be changed in order to run the software through
vglrun, which is done in the start_sdl script as an example.
Usually it is enough to prefix the commands with (where <code>:0</code> is the host
X server to use for rendering)</p>
<pre><code>vglrun -c 0 -d :0
</code></pre>

<p>Please note that this could be a security breach if an attacker takes control
of your AiC virtual device and finds a way to control the "sdl" container, as X
security and isolation is notorious for not existing.</p>
<h2 id="mesa">Mesa</h2>
<h3 id="dockerfile">Dockerfile</h3>
<p>You need to add the relevant mesa drivers to the list of packages to
install in the container image. This is setup-specific so we will
not cover it here.</p>
<p>You also need to install virtualgl, which is not in the official ubuntu
repos, so you need to download the <a href="https://sourceforge.net/projects/virtualgl/files/">latest deb</a>
and install it inside the Dockerfile.</p>
<pre><code class="Dockerfile">COPY virtualgl_2.X_amd64.deb /tmp/virtualgl_2.X_amd64.deb
RUN dpkg -i /tmp/virtualgl_2.X_amd64.deb
</code></pre>

<h3 id="docker-compose">Docker-compose</h3>
<p>You will need to change the docker-compose file in order to share the
X server socket from the host in a read/write volume to the "sdl" container:</p>
<pre><code class="yaml">  sdl:
    …
    volumes:
      …
      - /tmp/.X11-unix/:/tmp/.X11-unix/:rw
</code></pre>

<p>And you will need to share /dev/dri/card0 (or not card0, depending on
your setup):</p>
<pre><code class="yaml">sdl:
    …
    devices:
      - /dev/dri/card0
</code></pre>

<h2 id="nvidia">Nvidia</h2>
<h3 id="dockerfile_1">Dockerfile</h3>
<p>You need to start from the
<a href="https://github.com/NVIDIA/nvidia-docker/blob/opengl/ubuntu-14.04/opengl/virtualgl/Dockerfile">nvidia-docker opengl Dockerfile</a>,
tagged opengl:virtualgl (but based on ubuntu 16.04, not 14.04), then
copy the sdl.Dockerfile and the start_sdl into the src/player directory,
and do a source build to recreate the container images.</p>
<h3 id="docker-compose_1">docker-compose</h3>
<p>The easiest way is to install the
<a href="https://github.com/NVIDIA/nvidia-docker">nvidia-docker plugin</a>
(needs a docker restart) and replace the run-player.yml file in
lib/docker/ with the following:</p>
<pre><code class="yaml">version: &quot;2&quot;

services:
  xorg:
    container_name: &quot;${AIC_AVM_PREFIX}xorg&quot;
    restart: unless-stopped
    image: aic.xorg
    ports:
      - 5900
    environment:
      - AIC_PLAYER_VNC_SECRET
      - AIC_PLAYER_MAX_DIMENSION
  ffserver:
    container_name: &quot;${AIC_AVM_PREFIX}ffserver&quot;
    restart: unless-stopped
    image: aic.ffserver
    ports:
      - 8090
  adb:
    container_name: &quot;${AIC_AVM_PREFIX}adb&quot;
    restart: unless-stopped
    image: aic.adb
    volumes_from:
      - container:${AIC_PROJECT_PREFIX}prjdata:ro
    environment:
      - AIC_PLAYER_VM_HOST
  sdl:
    container_name: &quot;${AIC_AVM_PREFIX}sdl&quot;
    restart: unless-stopped
    devices:
      - /dev/nvidia0
      - /dev/nvidiactl
      - /dev/nvidia-uvm
    image: aic.sdl
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - nvidia_driver_370.28:/usr/local/nvidia:ro
    volumes_from:
      - avmdata
    # command: tail -f /dev/null
    environment:
      - AIC_PLAYER_AMQP_HOST
      - AIC_PLAYER_AMQP_USERNAME
      - AIC_PLAYER_AMQP_PASSWORD
      - AIC_PLAYER_VM_ID
      - AIC_PLAYER_VM_HOST
      - AIC_PLAYER_WIDTH
      - AIC_PLAYER_HEIGHT
      - AIC_PLAYER_DPI
      - AIC_PLAYER_ENABLE_RECORD
      - AIC_PLAYER_ANDROID_VERSION
      - AIC_PLAYER_PATH_RECORD
    # to be able to strace
    privileged: false
    depends_on:
      - xorg
    networks:
      - default
      - services_default
    external_links:
      - rabbitmq:rabbitmq
  audio:
    # command: tail -f /dev/null
    container_name: &quot;${AIC_AVM_PREFIX}audio&quot;
    restart: unless-stopped
    image: aic.audio
    environment:
      - AIC_PLAYER_VM_HOST
    depends_on:
      - ffserver
    networks:
      - default
      - services_default
    external_links:
      - rabbitmq:rabbitmq
  sensors:
    # command: tail -f /dev/null
    container_name: &quot;${AIC_AVM_PREFIX}sensors&quot;
    restart: unless-stopped
    image: aic.sensors
    environment:
      - AIC_PLAYER_AMQP_HOST
      - AIC_PLAYER_AMQP_USERNAME
      - AIC_PLAYER_AMQP_PASSWORD
      - AIC_PLAYER_VM_HOST
      - AIC_PLAYER_VM_ID
      - AIC_PLAYER_ENABLE_SENSORS
      - AIC_PLAYER_ENABLE_BATTERY
      - AIC_PLAYER_ENABLE_GPS
      - AIC_PLAYER_ENABLE_GSM
      - AIC_PLAYER_ENABLE_NFC
    networks:
      - default
      - services_default
    external_links:
      - rabbitmq:rabbitmq
  camera:
    # command: tail -f /dev/null
    container_name: &quot;${AIC_AVM_PREFIX}camera&quot;
    restart: unless-stopped
    image: aic.camera
    environment:
      - AIC_PLAYER_AMQP_HOST
      - AIC_PLAYER_AMQP_USERNAME
      - AIC_PLAYER_AMQP_PASSWORD
      - AIC_PLAYER_VM_HOST
      - AIC_PLAYER_VM_ID
    volumes_from:
      - container:${AIC_PROJECT_PREFIX}prjdata:ro
    networks:
      - default
      - services_default
    external_links:
      - rabbitmq:rabbitmq
  avmdata:
    container_name: &quot;${AIC_AVM_PREFIX}avmdata&quot;
    restart: unless-stopped
    image: aic.avmdata
    volumes:
      - /data/avm
    networks: []

networks:
  services_default:
    external: true
  default:

volumes:
  nvidia_driver_370.28:
    external: true
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="../.." class="btn btn-neutral" title="AiC Local"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>
    
  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../.." style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
    </span>
</div>
    <script src="../../js/theme.js"></script>

</body>
</html>
